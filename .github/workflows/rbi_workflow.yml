name: Java CI with Gradle

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4

    - name: Set PowerShell Execution Policy to Bypass
      run: |
        Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
        echo "Execution Policy Set"

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # Set the WORKSPACE environment variable
    - name: Set WORKSPACE environment variable
      run: echo "WORKSPACE=${GITHUB_WORKSPACE}" >> $GITHUB_ENV

    # Step 2: Install Chrome on Windows
    - name: Install Google Chrome
      run: |
        $chromeInstaller = "chrome_installer.exe"
        Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile $chromeInstaller
        Start-Process -FilePath $chromeInstaller -Args "/silent /install" -NoNewWindow -Wait
        Remove-Item $chromeInstaller -Force
        $env:PATH += ";C:\Program Files\Google\Chrome\Application"

   # Step 5: Fetch Latest Stable ChromeDriver version and download it
    - name: Install Latest Stable ChromeDriver
      run: |
          # Fetch the latest stable Chrome version dynamically from Chrome for Testing
          $chromeDriverVersionUrl = "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE"
          $chromeDriverVersion = Invoke-WebRequest -Uri $chromeDriverVersionUrl -UseBasicParsing | Select-Object -First 1
          Write-Host "Latest ChromeDriver Version: $chromeDriverVersion"

          # Construct the download URL for ChromeDriver using the fetched Chrome version
          $chromeDriverUrl = "https://storage.googleapis.com/chrome-for-testing-public/$chromeDriverVersion/win64/chromedriver-win64.zip"
    
          # Set temporary paths for download
          $tempPath = [System.IO.Path]::GetTempPath()
          $chromeDriverZipPath = Join-Path -Path $tempPath -ChildPath "chromedriver.zip"
          $chromeDriverExtractPath = "C:\tools\chromedriver"

          # Download ChromeDriver
          Write-Host "Downloading ChromeDriver..."
          Invoke-WebRequest -Uri $chromeDriverUrl -OutFile $chromeDriverZipPath -UseBasicParsing
    
          # Extract ChromeDriver with force overwrite option
          Write-Host "Extracting ChromeDriver..."
          Expand-Archive -Path $chromeDriverZipPath -DestinationPath $chromeDriverExtractPath -Force
          Remove-Item -Path $chromeDriverZipPath  # Clean up the zip file

          # Check if chromedriver_64 folder exists and move chromedriver.exe
          if (Test-Path "$chromeDriverExtractPath\chromedriver_64\chromedriver.exe") {
              Write-Host "Moving chromedriver.exe from chromedriver_64 folder..."
              Move-Item "$chromeDriverExtractPath\chromedriver_64\chromedriver.exe" "$chromeDriverExtractPath\chromedriver.exe"
              Remove-Item -Recurse -Force "$chromeDriverExtractPath\chromedriver_64"  # Clean up the folder
          }

          # Add ChromeDriver to PATH (for the current session)
          $env:PATH += ";C:\tools\chromedriver"

          # Explicitly call chromedriver.exe using its full path to verify installation
          Write-Host "Verifying ChromeDriver installation..."
          $chromedriverVersion = & "C:\tools\chromedriver\chromedriver.exe" --version
          Write-Host $chromedriverVersion

   # Step 6: Grant execute permission for Gradle wrapper (Windows-compatible method)
    - name: Grant execute permission for Gradle wrapper (Windows)
      run: |
          $gradlewPath = "./gradlew"
          icacls $gradlewPath /grant "Authenticated Users:(RX)"

    # Run tests using Gradle Wrapper (Windows)
    - name: Run Selenium tests
      working-directory: mission
      run: |
        gradle clean test "-Dsuite.name=rbi_meetinglist" --info
